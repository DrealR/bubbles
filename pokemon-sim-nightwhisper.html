<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pokémon Battle Arena Bubble</title>
    <style>
      :root {
        --font-sans: "system-ui", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif,
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
          "Noto Color Emoji";

        /* Colors */
        --color-primary-start: #4f46e5; /* indigo-600 */
        --color-primary-mid: #a855f7; /* purple-500 */
        --color-primary-end: #ec4899; /* pink-500 */
        --color-secondary-start: #06b6d4; /* cyan-500 */
        --color-secondary-end: #22d3ee; /* cyan-400 */
        --color-tertiary-start: #f97316; /* orange-500 */
        --color-tertiary-end: #ef4444; /* red-500 */
        --color-grass-start: #22c55e; /* green-500 */
        --color-grass-end: #10b981; /* emerald-500 */
        --color-water-start: #3b82f6; /* blue-500 */
        --color-water-end: #06b6d4; /* cyan-500 */
        --color-normal-start: #6b7280; /* gray-500 */
        --color-normal-end: #64748b; /* slate-500 */

        --color-bg-start: #e0e7ff; /* indigo-100 */
        --color-bg-mid: #ffffff;
        --color-bg-end: #ccfbf1; /* teal-100 */
        --color-text-default: #334155; /* slate-700 */
        --color-text-muted: #64748b; /* slate-500 */
        --color-border: #e2e8f0; /* slate-200 */
        --color-border-light: rgba(226, 232, 240, 0.5); /* slate-200/50 */
        --color-panel-bg: rgba(255, 255, 255, 0.7); /* white/70 */
        --color-shadow: rgba(0, 0, 0, 0.1);
        --color-shadow-lg: rgba(0, 0, 0, 0.15);

        /* Health Bar Colors */
        --hp-high: #4ade80; /* green-400 */
        --hp-medium: #facc15; /* yellow-400 */
        --hp-low: #f87171; /* red-400 */

        /* Bubble specific */
        --bubble-pop-button-bg: rgba(255, 255, 255, 0.8);
        --bubble-pop-button-bg-hover: rgba(255, 255, 255, 0.95);
        --bubble-pop-button-icon-color: var(--color-primary-start);
        --bubble-pop-button-icon-color-hover: var(--color-primary-mid);
        --bubble-border-radius: 30px;
        --bubble-pop-duration: 0.4s;
        --focus-ring: 0 0 0 3px var(--color-primary-mid);

        /* Spacing */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;

        /* Borders */
        --radius-md: 0.375rem;
        --radius-lg: 0.5rem;
        --radius-xl: 0.75rem;
        --radius-full: 9999px;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        font-size: 100%;
        scroll-behavior: smooth;
      }

      body {
        font-family: var(--font-sans);
        color: var(--color-text-default);
        background: linear-gradient(
          to bottom right,
          var(--color-bg-start),
          var(--color-bg-mid),
          var(--color-bg-end)
        );
        display: flex; /* Use flex to center wrapper */
        align-items: center; /* Vertically center wrapper */
        justify-content: center; /* Horizontally center wrapper */
        min-height: 100vh;
        padding: var(--space-4);
        position: relative;
        overflow: hidden;
        line-height: 1.5;
      }

      /* Bubble Wrapper Styling */
      #bubble-wrapper {
        width: 100%;
        max-width: 1100px; /* Allow wrapper to be slightly larger than arena max-width */
        min-height: 80vh; /* Give it some vertical presence */
        background: rgba(255, 255, 255, 0.4); /* Semi-transparent white base */
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: var(--bubble-border-radius);
        box-shadow: 0 0 0 10px rgba(255, 255, 255, 0.3),
          0 10px 30px rgba(0, 0, 0, 0.1); /* Outer glow and shadow */
        padding: var(--space-4);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Center content inside wrapper */
        transition: transform var(--bubble-pop-duration) ease-out,
          opacity var(--bubble-pop-duration) ease-out;
        transform-origin: center center;
        overflow: hidden; /* Clip content during pop */
        position: relative; /* Needed for background overlay positioning inside */
        z-index: 1; /* Above body background */
      }

      @media (min-width: 768px) {
        #bubble-wrapper {
          padding: var(--space-6);
        }
      }

      /* Pop Out Animation */
      #bubble-wrapper.popping-out {
        transform: scale(1.3);
        opacity: 0;
        pointer-events: none;
      }

      @keyframes pop-out-animation {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(1.3);
          opacity: 0;
        }
      }

      /* Apply animation only if not reduced motion */
      @media (prefers-reduced-motion: no-preference) {
        #bubble-wrapper.popping-out {
          animation: pop-out-animation var(--bubble-pop-duration) ease-out
            forwards;
        }
      }

      /* Pop Bubble Button */
      #pop-bubble-button {
        position: fixed;
        top: 1.5rem;
        left: 1.5rem;
        z-index: 1000; /* Above everything else */
        width: 44px;
        height: 44px;
        background-color: var(--bubble-pop-button-bg);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        transition: background-color 0.2s ease, transform 0.2s ease,
          box-shadow 0.2s ease;
        appearance: none;
        padding: 0;
      }

      #pop-bubble-button svg {
        width: 24px;
        height: 24px;
        color: var(--bubble-pop-button-icon-color);
        transition: color 0.2s ease;
      }

      #pop-bubble-button:hover {
        background-color: var(--bubble-pop-button-bg-hover);
        transform: scale(1.1);
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
      }
      #pop-bubble-button:hover svg {
        color: var(--bubble-pop-button-icon-color-hover);
      }

      #pop-bubble-button:focus {
        outline: none;
      }
      #pop-bubble-button:focus-visible {
        box-shadow: var(--focus-ring), 0 3px 8px rgba(0, 0, 0, 0.1);
      }

      #pop-bubble-button:active {
        transform: scale(1);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      }

      /* Background decorative elements - Now relative to bubble-wrapper */
      .background-overlay {
        position: absolute;
        inset: 0;
        overflow: hidden;
        z-index: 0; /* Behind content within the wrapper */
        pointer-events: none;
        border-radius: inherit; /* Match wrapper rounding */
      }
      .bg-shape-1 {
        position: absolute;
        bottom: -25%;
        left: 25%;
        width: 75%;
        height: 75%;
        background: radial-gradient(
          circle,
          rgba(6, 182, 212, 0.15) 0%,
          transparent 70%
        );
        border-radius: var(--radius-full);
        filter: blur(60px);
        opacity: 0.7;
        transform: rotate(-45deg);
      }
      .bg-shape-2 {
        position: absolute;
        top: -25%;
        right: 25%;
        width: 50%;
        height: 50%;
        background: radial-gradient(
          circle,
          rgba(251, 146, 60, 0.1) 0%,
          transparent 70%
        );
        border-radius: var(--radius-full);
        filter: blur(60px);
        opacity: 0.8;
        transform: rotate(12deg);
      }
      .bg-arena-floor {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 33%;
        background: linear-gradient(
          to top,
          rgba(167, 243, 208, 0.3),
          rgba(236, 253, 245, 0.1),
          transparent
        );
      }
      .bg-texture {
        position: absolute;
        inset: 0;
        background-color: rgba(230, 240, 255, 0.03); /* Subtle overlay */
        opacity: 0.5;
        mix-blend-mode: overlay;
      }

      .battle-arena {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 900px; /* Increased max-width for better layout */
        position: relative;
        z-index: 1; /* Above background overlay */
      }

      .main-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: var(--space-6);
        background: linear-gradient(
          to right,
          var(--color-primary-start),
          var(--color-primary-mid),
          var(--color-primary-end)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        padding-bottom: var(--space-1);
        margin-top: var(--space-4); /* Added margin top */
      }

      .battle-stage {
        width: 100%;
        height: 350px; /* Adjusted height */
        position: relative;
        margin-bottom: var(--space-6);
        display: flex;
        justify-content: space-between;
        align-items: center; /* Center Pokemon vertically */
      }

      .player-area {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: opacity 0.3s ease-in-out;
        opacity: 0.8;
        z-index: 10; /* Ensure Pokemon are above stage floor */
      }
      .player-area.active {
        opacity: 1;
      }
      .player-area.player-1 {
        left: 5%;
      }
      .player-area.player-2 {
        right: 5%;
      }

      .pokemon-sprite {
        width: 128px;
        height: 128px;
        object-fit: contain;
        transition: transform 0.3s ease;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
      }
      .player-area.active .pokemon-sprite {
        animation: bounce-slow 1.5s infinite;
      }
      .player-2 .pokemon-sprite {
        transform: scaleX(-1);
      }
      .player-area.active.player-2 .pokemon-sprite {
        transform: scaleX(-1) translateY(-4%);
      }

      .pokemon-info {
        margin-top: var(--space-3);
        background: var(--color-panel-bg);
        backdrop-filter: blur(8px);
        padding: var(--space-3);
        border-radius: var(--radius-xl);
        box-shadow: 0 4px 6px var(--color-shadow);
        width: 180px;
        text-align: center;
        border: 1px solid var(--color-border-light);
      }

      .pokemon-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-text-default);
        margin-bottom: var(--space-1);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .health-bar-container {
        width: 100%;
        background-color: var(--color-border);
        border-radius: var(--radius-full);
        height: 0.75rem; /* Increased height slightly */
        overflow: hidden;
        border: 1px solid #d1d5db; /* slate-300 */
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        margin-bottom: var(--space-1);
      }

      .health-bar {
        height: 100%;
        border-radius: var(--radius-full);
        transition: width 0.5s ease-out, background-color 0.5s ease;
        background-color: var(--hp-high);
      }
      .health-bar.medium {
        background-color: var(--hp-medium);
      }
      .health-bar.low {
        background-color: var(--hp-low);
      }

      .hp-text {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        margin-top: var(--space-1);
      }
      .resonance-text {
        font-size: 0.75rem;
        color: var(--color-primary-start);
        margin-top: var(--space-1);
        font-weight: 500;
      }

      /* Stage floor elements */
      .stage-floor-gradient {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 112px; /* h-28 */
        background: linear-gradient(
          to top,
          rgba(34, 197, 94, 0.2),
          rgba(220, 252, 231, 0.1),
          transparent
        );
        z-index: 1; /* Above background, below pokemon */
      }
      .pokemon-shadow {
        position: absolute;
        bottom: 30px; /* Adjust as needed based on sprite size */
        width: 80px;
        height: 10px;
        background: radial-gradient(
          ellipse at center,
          rgba(0, 0, 0, 0.2) 0%,
          rgba(0, 0, 0, 0) 70%
        );
        border-radius: 50%;
        z-index: 5; /* Above stage floor gradient */
        filter: blur(2px);
      }
      .player-1 .pokemon-shadow {
        left: calc(5% + 50px);
      } /* Center under sprite */
      .player-2 .pokemon-shadow {
        right: calc(5% + 50px);
      }

      .attack-animation-container {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 20;
        overflow: hidden; /* Clip animations within stage */
      }

      .attack-icon {
        position: absolute;
        width: 40px;
        height: 40px;
        transform: translate(-50%, -50%);
        transition: left 0.45s cubic-bezier(0.25, 0.1, 0.25, 1),
          /* Different ease for movement */ opacity 0.3s ease-in 0.3s; /* Fade out starts later */
        opacity: 1;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }
      .attack-icon svg {
        width: 100%;
        height: 100%;
      }
      /* Type specific icon colors */
      .attack-icon.fire svg {
        color: var(--color-tertiary-start);
      }
      .attack-icon.water svg {
        color: var(--color-water-start);
      }
      .attack-icon.grass svg {
        color: var(--color-grass-start);
      }
      .attack-icon.normal svg {
        color: var(--color-normal-start);
      }

      .battle-log-container,
      .action-controls-container,
      .game-over-container {
        width: 100%;
        max-width: 500px; /* Consistent width for controls/log */
        background: var(--color-panel-bg);
        backdrop-filter: blur(10px);
        padding: var(--space-5);
        border-radius: var(--radius-xl);
        box-shadow: 0 6px 12px var(--color-shadow-lg);
        margin-bottom: var(--space-6);
        z-index: 10;
        border: 1px solid var(--color-border-light);
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: var(--space-3);
        text-align: center;
        color: var(--color-text-default);
      }

      .battle-log {
        height: 112px; /* h-28 */
        overflow-y: auto;
        font-size: 0.875rem; /* text-sm */
        color: var(--color-text-muted);
        border-top: 1px solid var(--color-border-light);
        padding-top: var(--space-3);
        padding-left: var(--space-2);
        padding-right: var(--space-2);
        scrollbar-width: thin;
        scrollbar-color: var(--color-border) transparent;
      }
      .battle-log p {
        margin-bottom: var(--space-1);
        line-height: 1.4;
      }
      .battle-log p:last-child {
        margin-bottom: 0;
      }

      /* Custom Scrollbar for Webkit */
      .battle-log::-webkit-scrollbar {
        width: 6px;
      }
      .battle-log::-webkit-scrollbar-track {
        background: transparent;
      }
      .battle-log::-webkit-scrollbar-thumb {
        background-color: var(--color-border);
        border-radius: var(--radius-full);
      }

      .action-controls {
        min-height: 150px; /* Ensure space even when opponent's turn */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .action-controls .section-title {
        color: var(--color-primary-start);
      }

      .move-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);
        width: 100%;
      }

      .move-button {
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        color: white;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s ease-in-out;
        transform: scale(1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: none;
        cursor: pointer;
        text-align: center;
        position: relative; /* For potential future pseudo-elements */
        overflow: hidden; /* Clip gradient background */
      }
      .move-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        filter: brightness(1.1);
      }
      .move-button:active:not(:disabled) {
        transform: scale(0.98);
        filter: brightness(0.95);
      }
      .move-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        filter: grayscale(30%);
      }
      .move-button:focus-visible {
        outline: 2px solid var(--color-primary-start);
        outline-offset: 2px;
      }

      /* Type Gradients */
      .move-button.fire {
        background: linear-gradient(
          to right,
          var(--color-tertiary-start),
          var(--color-tertiary-end)
        );
      }
      .move-button.water {
        background: linear-gradient(
          to right,
          var(--color-water-start),
          var(--color-water-end)
        );
      }
      .move-button.grass {
        background: linear-gradient(
          to right,
          var(--color-grass-start),
          var(--color-grass-end)
        );
      }
      .move-button.normal {
        background: linear-gradient(
          to right,
          var(--color-normal-start),
          var(--color-normal-end)
        );
      }

      .move-type {
        font-size: 0.7rem;
        opacity: 0.8;
        margin-left: var(--space-1);
      }

      .game-over-container {
        text-align: center;
        padding: var(--space-6);
      }
      .game-over-text {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: var(--space-4);
        color: var(--color-primary-mid);
      }
      .play-again-button {
        padding: var(--space-3) var(--space-6);
        background: linear-gradient(
          to right,
          var(--color-grass-start),
          var(--color-grass-end)
        );
        color: white;
        border: none;
        border-radius: var(--radius-lg);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: scale(1);
      }
      .play-again-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        filter: brightness(1.1);
      }
      .play-again-button:focus-visible {
        outline: 2px solid var(--color-grass-start);
        outline-offset: 2px;
      }

      /* Prompt Info Footer */
      .prompt-info {
        text-align: center;
        margin-top: var(--space-6); /* Space above */
        padding-top: var(--space-4);
        border-top: 1px solid var(--color-border-light);
        width: 100%;
        max-width: 900px;
        font-size: 0.85rem;
        color: var(--color-text-muted);
        line-height: 1.5;
        position: relative; /* Ensure it's within the flow */
        z-index: 1; /* Above background overlay */
      }
      .prompt-info code {
        background-color: rgba(79, 70, 229, 0.1); /* primary-start with alpha */
        color: var(--color-primary-start);
        padding: 0.2em 0.5em;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: 0.9em;
      }

      @keyframes bounce-slow {
        0%,
        100% {
          transform: translateY(-4%);
          animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
        50% {
          transform: translateY(0);
          animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
      }

      /* Simple Responsive Adjustments */
      @media (max-width: 768px) {
        #bubble-wrapper {
          min-height: 90vh;
        } /* Take more height on mobile */
        .main-title {
          font-size: 1.75rem;
          margin-bottom: var(--space-4);
        }
        .battle-stage {
          height: 300px;
          margin-bottom: var(--space-4);
        }
        .pokemon-sprite {
          width: 96px;
          height: 96px;
        }
        .pokemon-info {
          width: 140px;
          padding: var(--space-2);
        }
        .pokemon-name {
          font-size: 1rem;
        }
        .hp-text,
        .resonance-text {
          font-size: 0.7rem;
        }
        .health-bar-container {
          height: 0.6rem;
        }
        .pokemon-shadow {
          width: 60px;
          height: 8px;
          bottom: 20px;
        }
        .player-1 .pokemon-shadow {
          left: calc(5% + 40px);
        }
        .player-2 .pokemon-shadow {
          right: calc(5% + 40px);
        }
        .attack-icon {
          width: 32px;
          height: 32px;
        }

        .battle-log-container,
        .action-controls-container {
          max-width: 95%;
        }
        .section-title {
          font-size: 1.1rem;
          margin-bottom: var(--space-2);
        }
        .battle-log {
          height: 90px;
          font-size: 0.8rem;
        }
        .move-buttons {
          gap: var(--space-2);
        }
        .move-button {
          font-size: 0.85rem;
          padding: var(--space-2);
        }
        .move-type {
          font-size: 0.65rem;
        }
        .play-again-button {
          padding: var(--space-2) var(--space-4);
          font-size: 0.9rem;
        }
        .prompt-info {
          font-size: 0.8rem;
        }
      }
      @media (max-width: 480px) {
        body {
          padding: var(--space-2);
        }
        #pop-bubble-button {
          top: 1rem;
          left: 1rem;
          width: 40px;
          height: 40px;
        }
        #pop-bubble-button svg {
          width: 20px;
          height: 20px;
        }
        #bubble-wrapper {
          padding: var(--space-2);
          border-radius: calc(var(--bubble-border-radius) * 0.75);
        }
        .main-title {
          font-size: 1.5rem;
          margin-top: var(--space-2);
        }
        .battle-stage {
          height: 250px;
        }
        .pokemon-sprite {
          width: 80px;
          height: 80px;
        }
        .pokemon-info {
          width: 120px;
        }
        .pokemon-name {
          font-size: 0.9rem;
        }
        .player-1 {
          left: 2%;
        }
        .player-2 {
          right: 2%;
        }
        .player-1 .pokemon-shadow {
          left: calc(2% + 20px);
        }
        .player-2 .pokemon-shadow {
          right: calc(2% + 20px);
        }
        .move-buttons {
          grid-template-columns: 1fr;
        } /* Stack buttons on very small screens */
        .battle-log-container,
        .action-controls-container,
        .game-over-container {
          padding: var(--space-3);
          margin-bottom: var(--space-4);
        }
        .prompt-info {
          margin-top: var(--space-4);
          font-size: 0.75rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Pop Bubble Button -->
    <button id="pop-bubble-button" aria-label="Pop bubble and return home">
      <svg aria-hidden="true" focusable="false">
        <use xlink:href="#icon-pop-bubble" />
      </svg>
    </button>

    <!-- Main Content Wrapper -->
    <div id="bubble-wrapper">
      <div class="background-overlay">
        <div class="bg-shape-1"></div>
        <div class="bg-shape-2"></div>
        <div class="bg-arena-floor"></div>
        <div class="bg-texture"></div>
      </div>

      <div id="battle-arena" class="battle-arena">
        <h1 class="main-title">Pokémon Battle Arena</h1>

        <div id="battle-stage" class="battle-stage">
          <div class="stage-floor-gradient"></div>

          <!-- Player 1 -->
          <div id="player1-area" class="player-area player-1">
            <img
              id="player1-sprite"
              src=""
              alt="Player 1 Pokémon"
              class="pokemon-sprite"
            />
            <div class="pokemon-shadow"></div>
            <div class="pokemon-info">
              <h3 id="player1-name" class="pokemon-name"></h3>
              <div class="health-bar-container">
                <div id="player1-hp-bar" class="health-bar"></div>
              </div>
              <p id="player1-hp-text" class="hp-text"></p>
              <p id="player1-resonance" class="resonance-text"></p>
            </div>
          </div>

          <!-- Player 2 -->
          <div id="player2-area" class="player-area player-2">
            <img
              id="player2-sprite"
              src=""
              alt="Player 2 Pokémon"
              class="pokemon-sprite"
            />
            <div class="pokemon-shadow"></div>
            <div class="pokemon-info">
              <h3 id="player2-name" class="pokemon-name"></h3>
              <div class="health-bar-container">
                <div id="player2-hp-bar" class="health-bar"></div>
              </div>
              <p id="player2-hp-text" class="hp-text"></p>
              <p id="player2-resonance" class="resonance-text"></p>
            </div>
          </div>

          <div
            id="attack-animation-container"
            class="attack-animation-container"
          >
            <!-- Attack animations will be added here -->
          </div>
        </div>

        <div id="battle-log-container" class="battle-log-container">
          <h2 class="section-title">Battle Log</h2>
          <div id="battle-log" class="battle-log" aria-live="polite"></div>
        </div>

        <div id="action-controls-container" class="action-controls-container">
          <div id="action-controls" class="action-controls">
            <h2 id="turn-indicator" class="section-title">
              Your Turn: Choose a move!
            </h2>
            <div id="move-buttons" class="move-buttons"></div>
          </div>
        </div>

        <div
          id="game-over-container"
          class="game-over-container"
          style="display: none"
        >
          <p id="game-over-text" class="game-over-text"></p>
          <button id="play-again-button" class="play-again-button">
            Play Again
          </button>
        </div>
      </div>
      <!-- End of battle-arena -->

      <footer class="prompt-info">
        <p>
          This Bubble was generated from the prompt:
          <code
            >Generate JavaScript code for a turn-based Pokémon battle simulator
            engine...[details omitted]...Style it as if it's an apple expert
            designer...[details omitted]...</code
          >
          with refinement:
          <code
            >add a way to go back to the index.html file...[details
            omitted]...like a bubble thing where you burst it...</code
          >
        </p>
      </footer>
    </div>
    <!-- End of bubble-wrapper -->

    <!-- SVG Icons Definition -->
    <svg width="0" height="0" style="position: absolute">
      <defs>
        <symbol
          id="icon-flame"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"
          />
        </symbol>
        <symbol
          id="icon-droplets"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"
          />
          <path
            d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"
          />
        </symbol>
        <symbol
          id="icon-leaf"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"
          />
          <path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12" />
        </symbol>
        <symbol
          id="icon-sword"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M14.5 17.5L21 21l-3-8.5-6.5-6.5L3 10.5l8.5 8.5L14.5 17.5z"
          ></path>
          <line x1="2" y1="22" x2="5" y2="19"></line>
        </symbol>
        <!-- Icon for Pop Bubble Button -->
        <symbol
          id="icon-pop-bubble"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M6.758 17.243L12.001 12m5.243-5.243L12 12m0 0L6.758 6.757M12.001 12l5.243 5.243"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </symbol>
      </defs>
    </svg>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Constants and Data ---
        const typeEffectivenessChart = {
          Fire: { Grass: 2, Water: 0.5, Fire: 0.5, Normal: 1 },
          Water: { Fire: 2, Grass: 0.5, Water: 0.5, Normal: 1 },
          Grass: { Water: 2, Fire: 0.5, Grass: 0.5, Normal: 1 },
          Normal: { Fire: 1, Water: 1, Grass: 1, Normal: 1 },
        };

        const initialPokemon1Data = {
          name: "Charizard",
          hp: 150,
          maxHp: 150,
          types: ["Fire"],
          resonance: 0,
          moves: [
            { name: "Flamethrower", type: "Fire", power: 90, accuracy: 1 },
            { name: "Slash", type: "Normal", power: 70, accuracy: 1 },
            { name: "Fire Blast", type: "Fire", power: 110, accuracy: 0.85 },
            { name: "Dragon Claw", type: "Normal", power: 80, accuracy: 1 },
          ],
          sprite:
            "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png",
        };
        const initialPokemon2Data = {
          name: "Venusaur",
          hp: 160,
          maxHp: 160,
          types: ["Grass"],
          resonance: 0,
          moves: [
            { name: "Solar Beam", type: "Grass", power: 120, accuracy: 1 },
            { name: "Take Down", type: "Normal", power: 90, accuracy: 0.85 },
            { name: "Giga Drain", type: "Grass", power: 75, accuracy: 1 },
            { name: "Body Slam", type: "Normal", power: 85, accuracy: 1 },
          ],
          sprite:
            "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/3.png",
        };

        // --- State Variables ---
        let player1, player2;
        let battleLog = [];
        let currentPlayer = "player1";
        let gameOver = false;
        let showMoveButtons = true;
        let attackTimeout = null; // To manage AI turn delay and button enable delay

        // --- DOM Elements ---
        const DOMElements = {
          bubbleWrapper: document.getElementById("bubble-wrapper"),
          popBubbleButton: document.getElementById("pop-bubble-button"),
          player1Area: document.getElementById("player1-area"),
          player1Sprite: document.getElementById("player1-sprite"),
          player1Name: document.getElementById("player1-name"),
          player1HpBar: document.getElementById("player1-hp-bar"),
          player1HpText: document.getElementById("player1-hp-text"),
          player1Resonance: document.getElementById("player1-resonance"),
          player2Area: document.getElementById("player2-area"),
          player2Sprite: document.getElementById("player2-sprite"),
          player2Name: document.getElementById("player2-name"),
          player2HpBar: document.getElementById("player2-hp-bar"),
          player2HpText: document.getElementById("player2-hp-text"),
          player2Resonance: document.getElementById("player2-resonance"),
          battleLogElement: document.getElementById("battle-log"),
          turnIndicator: document.getElementById("turn-indicator"),
          moveButtonsContainer: document.getElementById("move-buttons"),
          actionControlsContainer: document.getElementById(
            "action-controls-container"
          ),
          gameOverContainer: document.getElementById("game-over-container"),
          gameOverText: document.getElementById("game-over-text"),
          playAgainButton: document.getElementById("play-again-button"),
          attackAnimationContainer: document.getElementById(
            "attack-animation-container"
          ),
          battleStage: document.getElementById("battle-stage"),
        };

        // --- Utility Functions ---

        /** Adds a message to the battle log and updates the UI. */
        function addLog(message) {
          battleLog = [message, ...battleLog.slice(0, 5)]; // Keep latest 6 messages
          updateBattleLog();
        }

        /** Calculates type effectiveness multiplier. */
        function calculateTypeEffectiveness(moveType, targetTypes) {
          let multiplier = 1;
          const effectiveness =
            typeEffectivenessChart[moveType] ||
            typeEffectivenessChart["Normal"]; // Default to normal if type not found
          targetTypes.forEach((type) => {
            multiplier *=
              effectiveness[type] !== undefined ? effectiveness[type] : 1;
          });
          return multiplier;
        }

        /** Creates an SVG icon element. */
        function createAttackIconElement(type) {
          const iconWrapper = document.createElement("div");
          iconWrapper.classList.add("attack-icon", type.toLowerCase());
          const svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg"
          );
          const use = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "use"
          );
          let iconId = "#icon-sword"; // Default to 'Normal'
          if (type === "Fire") iconId = "#icon-flame";
          else if (type === "Water") iconId = "#icon-droplets";
          else if (type === "Grass") iconId = "#icon-leaf";
          use.setAttributeNS("http://www.w3.org/1999/xlink", "href", iconId);
          svg.appendChild(use);
          iconWrapper.appendChild(svg);
          return iconWrapper;
        }

        /** Displays the attack animation. */
        function playAttackAnimation({ type, attacker }) {
          const startElement =
            attacker === "player1"
              ? DOMElements.player1Sprite
              : DOMElements.player2Sprite;
          const endElement =
            attacker === "player1"
              ? DOMElements.player2Sprite
              : DOMElements.player1Sprite;

          const stageRect = DOMElements.battleStage.getBoundingClientRect();
          const startRect = startElement.getBoundingClientRect();
          const endRect = endElement.getBoundingClientRect();

          // Calculate positions relative to the stage's top-left corner
          const startPos = {
            left: `${
              ((startRect.left + startRect.width / 2 - stageRect.left) /
                stageRect.width) *
              100
            }%`,
            top: `${
              ((startRect.top + startRect.height / 2 - stageRect.top) /
                stageRect.height) *
              100
            }%`,
          };
          const endPos = {
            left: `${
              ((endRect.left + endRect.width / 2 - stageRect.left) /
                stageRect.width) *
              100
            }%`,
            top: `${
              ((endRect.top + endRect.height / 2 - stageRect.top) /
                stageRect.height) *
              100
            }%`,
          };

          const iconElement = createAttackIconElement(type);
          iconElement.style.left = startPos.left;
          iconElement.style.top = startPos.top;
          iconElement.style.opacity = "1";

          DOMElements.attackAnimationContainer.appendChild(iconElement);

          requestAnimationFrame(() => {
            // Use rAF for smoother start
            iconElement.style.left = endPos.left;
            iconElement.style.opacity = "0";
          });

          setTimeout(() => {
            if (
              iconElement.parentNode === DOMElements.attackAnimationContainer
            ) {
              DOMElements.attackAnimationContainer.removeChild(iconElement);
            }
          }, 800); // CSS transition duration + fade delay
        }

        // --- UI Update Functions ---

        /** Updates the display for a single Pokémon. */
        function updatePokemonDisplay(
          player,
          areaEl,
          spriteEl,
          nameEl,
          hpBarEl,
          hpTextEl,
          resonanceEl
        ) {
          spriteEl.src = player.sprite;
          spriteEl.alt = player.name;
          nameEl.textContent = player.name;
          resonanceEl.textContent = `Resonance: ${player.resonance}`;

          const hpPercentage = Math.max(0, (player.hp / player.maxHp) * 100);
          hpBarEl.style.width = `${hpPercentage}%`;
          hpBarEl.classList.remove("low", "medium");
          if (hpPercentage < 20) hpBarEl.classList.add("low");
          else if (hpPercentage < 50) hpBarEl.classList.add("medium");

          hpTextEl.textContent = `${player.hp} / ${player.maxHp} HP`;

          // Update active state visual
          if (
            currentPlayer === (player === player1 ? "player1" : "player2") &&
            !gameOver
          ) {
            areaEl.classList.add("active");
          } else {
            areaEl.classList.remove("active");
          }
        }

        /** Updates both Pokémon displays. */
        function updateAllPokemonDisplays() {
          updatePokemonDisplay(
            player1,
            DOMElements.player1Area,
            DOMElements.player1Sprite,
            DOMElements.player1Name,
            DOMElements.player1HpBar,
            DOMElements.player1HpText,
            DOMElements.player1Resonance
          );
          updatePokemonDisplay(
            player2,
            DOMElements.player2Area,
            DOMElements.player2Sprite,
            DOMElements.player2Name,
            DOMElements.player2HpBar,
            DOMElements.player2HpText,
            DOMElements.player2Resonance
          );
        }

        /** Updates the battle log UI. */
        function updateBattleLog() {
          DOMElements.battleLogElement.innerHTML = battleLog
            .map((msg) => `<p>${msg}</p>`)
            .join("");
          DOMElements.battleLogElement.scrollTop = 0; // Scroll to top
        }

        /** Updates the action controls (turn indicator and move buttons). */
        function updateControls() {
          DOMElements.moveButtonsContainer.innerHTML = ""; // Clear existing buttons

          if (gameOver) {
            DOMElements.actionControlsContainer.style.display = "none";
            DOMElements.gameOverContainer.style.display = "block";
            const winner = player1.hp > 0 ? player1.name : player2.name;
            DOMElements.gameOverText.textContent = `${winner} wins!`;
            DOMElements.player1Area.classList.remove("active");
            DOMElements.player2Area.classList.remove("active");
            return;
          }

          DOMElements.actionControlsContainer.style.display = "block";
          DOMElements.gameOverContainer.style.display = "none";

          if (currentPlayer === "player1") {
            DOMElements.turnIndicator.textContent = "Your Turn: Choose a move!";
            player1.moves.forEach((move, index) => {
              const button = document.createElement("button");
              button.classList.add("move-button", move.type.toLowerCase());
              button.innerHTML = `${move.name} <span class="move-type">(${move.type})</span>`;
              button.disabled = !showMoveButtons;
              button.addEventListener("click", () =>
                handleAttack(player1, player2, index)
              );
              DOMElements.moveButtonsContainer.appendChild(button);
            });
          } else {
            DOMElements.turnIndicator.textContent = "Opponent's Turn...";
          }
        }

        // --- Core Battle Logic ---

        /** Handles a Pokémon attacking another. */
        function handleAttack(attacker, defender, moveIndex) {
          if (
            gameOver ||
            (attacker === player1 && currentPlayer !== "player1") ||
            (attacker === player2 && currentPlayer !== "player2")
          )
            return;

          showMoveButtons = false; // Disable buttons immediately
          updateControls(); // Reflect disabled state

          const move = attacker.moves[moveIndex];
          addLog(`${attacker.name} used ${move.name}!`);
          playAttackAnimation({
            type: move.type,
            attacker: attacker === player1 ? "player1" : "player2",
          });

          clearTimeout(attackTimeout); // Clear any pending AI or button enable timers
          attackTimeout = setTimeout(() => {
            let damageDealt = 0;
            if (Math.random() < move.accuracy) {
              let power = move.power;
              let resonanceTriggered = false;
              if (
                attacker.resonance >= 3 &&
                attacker.types.includes(move.type)
              ) {
                power += 10; // Synergy Resonance boost
                resonanceTriggered = true;
                addLog(
                  `${attacker.name}'s Synergy Resonance boosted ${move.name}!`
                );
                attacker.resonance = 0; // Reset resonance after use
              }

              const effectiveness = calculateTypeEffectiveness(
                move.type,
                defender.types
              );
              damageDealt = Math.round(
                power * effectiveness * (Math.random() * 0.15 + 0.85)
              ); // Basic damage formula

              let effectivenessText = "";
              if (effectiveness > 1)
                effectivenessText = "It's super effective!";
              if (effectiveness < 1 && effectiveness > 0)
                effectivenessText = "It's not very effective...";
              if (effectiveness === 0) {
                effectivenessText = `It doesn't affect ${defender.name}...`;
                damageDealt = 0;
              }

              if (effectivenessText) addLog(effectivenessText);

              const newHp = Math.max(0, defender.hp - damageDealt);
              addLog(`${defender.name} took ${damageDealt} damage.`);
              defender.hp = newHp;

              // Update resonance
              if (!resonanceTriggered)
                attacker.resonance += effectiveness > 1 ? 1 : 0;
              defender.resonance +=
                effectiveness < 1 && effectiveness > 0 ? 1 : 0;

              if (newHp === 0) {
                addLog(`${defender.name} fainted!`);
                gameOver = true;
              }
            } else {
              addLog(`${attacker.name}'s attack missed!`);
            }

            updateAllPokemonDisplays(); // Update UI after damage

            // Switch turn or end game
            if (!gameOver) {
              currentPlayer =
                currentPlayer === "player1" ? "player2" : "player1";
              updateControls();
              handleTurn();
            } else {
              updateControls(); // Show game over state
            }
          }, 600); // Delay matching animation + buffer
        }

        /** Handles the logic for the current player's turn (AI or enabling buttons). */
        function handleTurn() {
          clearTimeout(attackTimeout); // Clear previous timers
          if (gameOver) return;

          if (currentPlayer === "player2") {
            // AI's turn
            const aiMoveIndex = Math.floor(
              Math.random() * player2.moves.length
            );
            const delay = 800 + Math.random() * 700; // Simulate thinking time
            attackTimeout = setTimeout(() => {
              handleAttack(player2, player1, aiMoveIndex);
            }, delay);
          } else {
            // Player's turn - enable buttons after a short delay
            attackTimeout = setTimeout(() => {
              showMoveButtons = true;
              updateControls();
            }, 300);
          }
          updateAllPokemonDisplays(); // Update active Pokemon indicator
        }

        /** Resets the game state and UI. */
        function resetGame() {
          clearTimeout(attackTimeout);
          player1 = JSON.parse(JSON.stringify(initialPokemon1Data)); // Deep clone
          player2 = JSON.parse(JSON.stringify(initialPokemon2Data));
          battleLog = ["Battle started!"];
          currentPlayer = "player1";
          gameOver = false;
          showMoveButtons = true;
          DOMElements.attackAnimationContainer.innerHTML = ""; // Clear animations

          updateAllPokemonDisplays();
          updateBattleLog();
          updateControls();
          handleTurn(); // Start the first turn
        }

        // --- Bubble Pop Logic ---

        /**
         * Gets animation duration from CSS Custom Property or uses fallback.
         * @param {string} propertyName - The CSS custom property name.
         * @param {number} fallbackMs - The fallback duration in milliseconds.
         * @returns {number} Duration in milliseconds.
         */
        function getCssVariableDuration(propertyName, fallbackMs) {
          try {
            const durationStr = getComputedStyle(document.documentElement)
              .getPropertyValue(propertyName)
              .trim();
            if (durationStr) {
              const match = durationStr.match(/^(\d*\.?\d+)(m?s)?$/i);
              if (match) {
                const value = parseFloat(match[1]);
                const unit = match[2]?.toLowerCase();
                if (unit === "s") return value * 1000;
                if (unit === "ms" || !unit) return value;
              }
            }
          } catch (e) {
            console.warn(
              `Could not parse CSS variable ${propertyName} as duration:`,
              e
            );
          }
          return fallbackMs;
        }

        /** Handles the 'Pop Bubble' button click. */
        function handlePopBubble() {
          const animationDuration = getCssVariableDuration(
            "--bubble-pop-duration",
            400
          );
          const prefersReducedMotion = window.matchMedia(
            "(prefers-reduced-motion: reduce)"
          ).matches;
          const destination = "index.html"; // Assume index is in the same directory

          if (prefersReducedMotion) {
            window.location.href = destination;
          } else {
            DOMElements.bubbleWrapper.classList.add("popping-out");
            setTimeout(() => {
              window.location.href = destination;
            }, animationDuration);
          }
        }

        // --- Initialization ---
        DOMElements.playAgainButton.addEventListener("click", resetGame);
        DOMElements.popBubbleButton.addEventListener("click", handlePopBubble);
        resetGame(); // Initialize the game on load
      });
    </script>
  </body>
</html>
